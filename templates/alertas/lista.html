{% extends "base.html" %}

{% block title %}Alertas de Inventario - Sistema de Inventario{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="bi bi-exclamation-triangle"></i> Alertas de Inventario</h1>
            <p class="text-muted">Alertas activas del sistema</p>
        </div>
    </div>
    
    {% if alertas %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Prioridad</th>
                                    <th>Tipo</th>
                                    <th>Repuesto</th>
                                    <th>Stock Actual</th>
                                    <th>Stock Mínimo</th>
                                    <th>Mensaje</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alerta in alertas %}
                                <tr>
                                    <td>
                                        {% if alerta.nivel_prioridad == 'CRITICA' %}
                                            <span class="badge bg-danger">CRÍTICA</span>
                                        {% elif alerta.nivel_prioridad == 'ALTA' %}
                                            <span class="badge bg-warning">ALTA</span>
                                        {% elif alerta.nivel_prioridad == 'MEDIA' %}
                                            <span class="badge bg-info">MEDIA</span>
                                        {% else %}
                                            <span class="badge bg-secondary">BAJA</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if alerta.tipo_alerta == 'AGOTADO' %}
                                            <i class="bi bi-x-circle text-danger"></i> Agotado
                                        {% elif alerta.tipo_alerta == 'STOCK_BAJO' %}
                                            <i class="bi bi-exclamation-triangle text-warning"></i> Stock Bajo
                                        {% else %}
                                            {{ alerta.tipo_alerta }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ alerta.nombre }}</strong><br>
                                        <small class="text-muted">{{ alerta.codigo }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-{{ 'danger' if alerta.cantidad_actual == 0 else 'warning' }}">
                                            {{ alerta.cantidad_actual }}
                                        </span>
                                    </td>
                                    <td class="text-center">{{ alerta.cantidad_minima }}</td>
                                    <td>{{ alerta.mensaje }}</td>
                                    <td>{{ alerta.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-success marcar-leida" 
                                                data-alerta-id="{{ alerta.id }}"
                                                title="Marcar como leída">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i> No hay alertas activas en este momento
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('.marcar-leida').click(function() {
        const alertaId = $(this).data('alerta-id');
        const btn = $(this);
        
        $.ajax({
            url: `/api/alertas/marcar-leida/${alertaId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    btn.closest('tr').fadeOut(400, function() {
                        $(this).remove();
                        
                        // Si no quedan alertas, mostrar mensaje
                        if ($('tbody tr').length === 0) {
                            location.reload();
                        }
                    });
                }
            },
            error: function() {
                alert('Error al marcar la alerta como leída');
            }
        });
    });
});
</script>
{% endblock %}
